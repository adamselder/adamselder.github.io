
# Data: Degree {#degree}



```{r, echo=FALSE, include=FALSE}
# https://github.com/rstudio/DT/issues/67
# You need this code to conduct the magic dependences attaching...
# Without it, the loops with DTs in them did NOT print
DT::datatable(matrix())
```


```{r degree-mutate}
#--------------------------------------------------------------------------------
# Ego tibble
#--------------------------------------------------------------------------------
egos <- network_list[[1]]$egos 
egos <- as_tibble(egos)

#--------------------------------------------------------------------------------
# Make some additional degree variables based on the ones provided - 
# this may not be necessary
#--------------------------------------------------------------------------------

# Variable that stores the joint degree values for each network pair
# It will be a concatenation of the degree vars, e.g. "deg.cohab-deg.pers"

# Also create concurrency indicators for within-net conc for each net
# and cross-net conc. They will be, e.g.
#     Cross-net conc: "deg.cohab-deg.pers_crossconc"
#     Within-net conc: "deg.cohab_conc"
#     Any conc: "deg.cohab-deg.pers_anyconc"

names(network_pairs) <- sapply(network_pairs, paste, collapse='-')
for (i in 1:length(network_pairs)) {
    
    # Convert to names that can be unquoted
    joint_name <- rlang::sym(names(network_pairs)[i])
    net1 <- rlang::sym(network_pairs[[i]][1])
    net2 <- rlang::sym(network_pairs[[i]][2])
    pair <- rlang::syms(network_pairs[[i]])
    # Create names for new variables
    cross_conc <- paste0(quo_name(joint_name), '_crossconc_only')
    any_conc <- paste0(quo_name(joint_name), '_anyconc')
    net1_conc <- paste0(quo_name(net1), '_conc_only')
    net1_cross_conc <- paste0(quo_name(net1), '_and_cross_conc')
    net2_cross_conc <- paste0(quo_name(net2), '_and_cross_conc')
    net2_conc <- paste0(quo_name(net2), '_conc_only')

    # Create     
    egos <- egos %>% 
	# Joint degree variable
	unite(!!joint_name, !!!pair, remove=FALSE)  %>% 
	# Concurrency indicators. I believe they must be 1/0 not TRUE/FALSE for survey pkg
	mutate(!!cross_conc := ifelse(!!net1 == 1 & !!net2 == 1, 1, 0),
	       !!net1_conc := ifelse(!!net1 > 1 & !!net2==0, 1, 0),
	       !!net2_conc := ifelse(!!net2 > 1 & !!net1==0, 1, 0),
	       !!net1_cross_conc := ifelse(!!net1 > 1 & !!net2 > 0, 1, 0),
	       !!net2_cross_conc := ifelse(!!net2 > 1 & !!net1 > 0, 1, 0),
	       !!any_conc := ifelse(!!net1 > 1 | !!net2 > 1 | (!!net1 > 0 & !!net2 > 0), 1, 0)
	       )

    if (1==0) {
	egos %>% table('deg.pers_conc', 'deg.cohab_conc')
	egos %>% group_by(`deg.cohab-deg.pers_anyconc`, `deg.cohab-deg.pers_crossconc_only`, 
			  deg.cohab_and_cross_conc, 
			  deg.pers_and_cross_conc, 
			  deg.pers_conc_only, deg.cohab_conc_only) %>% summarize(count=n())
    }

}

#--------------------------------------------------------------------------------
# Survey object for ego tibble
#--------------------------------------------------------------------------------
svy <- egos %>% as_survey(ids=1, weights=weight)


```{r, echo=FALSE,include = FALSE}
# CHECKING OUT DATA TABLE
# https://github.com/rstudio/DT/issues/67
# You need this code to conduct the magic dependences attaching...
DT::datatable(matrix())
```

```{r degree-tabs-plots-nets-overview}
#------------------------------------------------------------
# Mean degree and degree distributions:
# compute tabs and generate plots
#------------------------------------------------------------

# Render plot_ly plots for use in a loop
# https://stackoverflow.com/questions/36234169/plotly-charts-in-a-for-loop

tables_nets_overview <- list()
plots_nets_overview <- htmltools::tagList()

for (i in 1:length(degree_vars)) {
    var <- degree_vars[i]
    tables_nets_overview[[i]] <- 
	transform(Network=names(degree_vars)[i],
		  mean_deg_kvar(svy, var, char_input=TRUE, round_to=3))
}

sumtable_nets_overview <- do.call('rbind', tables_nets_overview)
# For use with datatable
sumtable_nets_overview_DT <- DT::datatable(sumtable_nets_overview, 
					   height="100%",
					   width="100%", 
					   rownames=FALSE)
plots_nets_overview <- plotly::style(plot_1var_mean_degree(sumtable_nets_overview, 
						       Network, char_input=FALSE),
				     hoverinfo='y')
``` 

```{r degree-tabs-plots-1way}
#------------------------------------------------------------
# 1-way stats: 
# compute tabs and generate plots
#------------------------------------------------------------

tables_1way_mean <- list()
DTables_1way_mean <- htmltools::tagList()
plots_1way_mean <- htmltools::tagList()
# Not using this right now
tables_1way_distr <- list()
# Render plot_ly plots for use in a loop
# https://stackoverflow.com/questions/36234169/plotly-charts-in-a-for-loop
plots_1way_distr <- htmltools::tagList()

for (i in 1:length(degree_1way_vars)) {
    var <- degree_1way_vars[i]

    tables_1way_mean[[i]] <- combine_mean_deg_nets(svy, degree_vars, 
						   char_input=TRUE, var)
    # Plot input must be a data frame, not a DT object. So turn it into DT separately.
    DTables_1way_mean[[i]] <- DT::datatable(tables_1way_mean[[i]],
					   height="100%",
					   width="100%", rownames=FALSE)
    plots_1way_mean[[i]] <- 
	as_widget(plotly::style(plot_kvar_mean_degree(tables_1way_mean[[i]], var, 
						      'network', 
						      char_input=TRUE), 
				hoverinfo='y'))
}
names(tables_1way_mean) <- names(DTables_1way_mean) <- 
    names(plots_1way_mean) <- degree_1way_vars
``` 

```{r degree-tabs-plots-2way}
#------------------------------------------------------------
# 2-way stats: 
# compute tabs and generate plots
#------------------------------------------------------------

# Render plot_ly plots for use in a loop
# https://stackoverflow.com/questions/36234169/plotly-charts-in-a-for-loop
tables_2way_mean <- list()
DTables_2way_mean <- htmltools::tagList()
plots_2way_mean <- htmltools::tagList()
tables_2way_distr <- list()
plots_2way_distr <- htmltools::tagList()

for (i in 1:length(degree_2way_vars)) {
    tables_2way_mean[[i]] <- combine_mean_deg_nets(svy, degree_vars, char_input=TRUE, 
						   degree_2way_vars[[i]])
    # Plot input must be a data frame, not a DT object. So turn it into DT separately.
    DTables_2way_mean[[i]] <- DT::datatable(tables_2way_mean[[i]],
					   height="100%",
					   width="100%", rownames=FALSE)
    plots_2way_mean[[i]] <- 
	as_widget(plotly::style(plot_kvar_mean_degree(tables_2way_mean[[i]], 
						      degree_2way_vars[[i]][1],
						      degree_2way_vars[[i]][2],
						      char_input=TRUE,
						      'network'),
				hoverinfo='y'))
}
degree_2way_vars_names <- sapply(degree_2way_vars, paste, collapse='_by_')
names(tables_2way_mean) <- names(DTables_2way_mean) <- 
    names(plots_2way_mean) <- degree_2way_vars_names
``` 

```{r degree-tabs-plots-crossnet-overview}
#------------------------------------------------------------
# Cross-network degree distribution for all network pairs
#------------------------------------------------------------

# Render plot_ly plots for use in a loop
# https://stackoverflow.com/questions/36234169/plotly-charts-in-a-for-loop
tables_crossnet_overview <- list()
DTables_crossnet_overview <- htmltools::tagList()
plots_crossnet_overview <- htmltools::tagList()
plots_crossnet_overview2 <- htmltools::tagList()

for (i in 1:length(network_pairs)) {

    # Convert to names that can be unquoted
    joint_name <- rlang::sym(names(network_pairs)[i])
    pair <- rlang::syms(network_pairs[[i]])
    pair1 <- rlang::sym(network_pairs[[i]][1])
    pair2 <- rlang::sym(network_pairs[[i]][2])

    # This is scarily slow
    tables_crossnet_overview[[i]] <- prop_kvar(svy, joint_name, 
					       char_input=TRUE, binary=FALSE)%>% 
				     separate(!!joint_name, into=c(network_pairs[[i]][1], 
								   network_pairs[[i]][2]))  %>% 
				     mutate(value=prop,
					    concurrency = ifelse(!!pair1 > 1 | !!pair2 > 1 | (!!pair1 > 0 & !!pair2 > 0), 'Concurrency', 'No conc'))

    # Plot input must be a data frame, not a DT object. So turn it into DT separately.
    DTables_crossnet_overview[[i]] <- DT::datatable(tables_crossnet_overview[[i]],
					   height="100%",
					   width="100%", rownames=FALSE)
    plots_crossnet_overview[[i]] <- 
	as_widget(plotly::style(
				plot_kvar(tables_crossnet_overview[[i]], 
					  network_pairs[[i]][1],
					  network_pairs[[i]][2],
					  char_input=TRUE) + 
				ggtitle(paste('Joint distribution of',
					    paste(network_pairs[[i]], collapse=', ')
					)),
				hoverinfo='y'))

    # Second plot with no error bars
    plot2 <- 
	ggplot(tables_crossnet_overview[[i]],
		   aes(x=deg.pers, y=deg.cohab, size=prop, color=concurrency)) + 
		    geom_point() +
		    scale_size_continuous(range=c(0,20)) +
#			scale_fill_manual(values=c('springgreen4', 'gray68')) +
		    scale_color_manual(values=c('springgreen4', 'gray68')) +
		    theme_bw() + 
		    guides(size=FALSE) + 
		    labs(color='') + 
#		    facet_grid(network~.) +
		    ggtitle('Joint distribution, no error bars')

    # I don't know why this works but plotly::style with hoverinfo='prop' does not
    plots_crossnet_overview2[[i]] <- as_widget(plotly::ggplotly(plot2, tooltip='prop',
						  height=300, 
						  width=600))
}
names(tables_crossnet_overview) <- names(DTables_crossnet_overview) <- 
    names(plots_crossnet_overview) <- names(plots_crossnet_overview2) <- names(network_pairs)
``` 

```{r degree-tabs-plots-concurrency-1way}
#------------------------------------------------------------
# 1-way concurrency and crossnet tab for all network pairs
#------------------------------------------------------------

# Render plot_ly plots for use in a loop
# https://stackoverflow.com/questions/36234169/plotly-charts-in-a-for-loop
tables_conc_1way <- list()
DTables_conc_1way <- list()
tables_crossnet_1way <- list()
DTables_crossnet_1way <- list()
plots_conc_1way <- list()
plots_crossnet_1way <- list()

for (i in 1:length(network_pairs)) {
    
    # Define sub-lists for this network pair
    tables_conc_1way[[i]] <- list()
    DTables_conc_1way[[i]] <- htmltools::tagList()
    tables_crossnet_1way[[i]] <- list()
    DTables_crossnet_1way[[i]] <- htmltools::tagList()
    plots_conc_1way[[i]] <- htmltools::tagList()
    plots_crossnet_1way[[i]] <- htmltools::tagList()


    # Identify concurrency variables for this network vair

    # Convert to names that can be unquoted
    joint_name <- rlang::sym(names(network_pairs)[i])
    net1 <- rlang::sym(network_pairs[[i]][1])
    net2 <- rlang::sym(network_pairs[[i]][2])
    pair <- rlang::syms(network_pairs[[i]])
    # Conc variables names
    cross_conc <- paste0(quo_name(joint_name), '_crossconc_only')
    any_conc <- paste0(quo_name(joint_name), '_anyconc')
    net1_conc <- paste0(quo_name(net1), '_conc_only')
    net1_cross_conc <- paste0(quo_name(net1), '_and_cross_conc')
    net2_cross_conc <- paste0(quo_name(net2), '_and_cross_conc')
    net2_conc <- paste0(quo_name(net2), '_conc_only')
    # Conc variables
    net1_conc_var <- rlang::sym(net1_conc)
    net2_conc_var <- rlang::sym(net2_conc)
    net1_cross_conc_var <- rlang::sym(net1_cross_conc)
    net2_cross_conc_var <- rlang::sym(net2_cross_conc)
    cross_conc_var <- rlang::sym(cross_conc)
    any_conc_var <- rlang::sym(any_conc)

    # Now do 1-way stats by variables

    for (j in 1:length(degree_1way_vars)) {

	var <- rlang::sym(degree_1way_vars[j])

	#Cross-network tab
	tables_crossnet_1way[[i]][[j]] <- prop_kvar(svy, joint_name, 
						   char_input=TRUE, binary=FALSE, degree_1way_vars[j]) %>% 
					 separate(!!joint_name, into=c(network_pairs[[i]][1], 
								       network_pairs[[i]][2]))  %>% 
					 mutate(value=prop,
						concurrency = ifelse(!!pair1 > 1 | !!pair2 > 1 | (!!pair1 > 0 & !!pair2 > 0), 
								     'Concurrency', 'No conc'))

	# Plot input must be a data frame, not a DT object. So turn it into DT separately.
	DTables_crossnet_1way[[i]][[j]] <- DT::datatable(tables_crossnet_1way[[i]][[j]],
					       height="100%",
					       width="100%", rownames=FALSE)
	plots_crossnet_1way[[i]][[j]] <- 
	    ggplot(tables_crossnet_1way[[i]][[j]],
		       aes(x=deg.pers, y=deg.cohab, size=prop, color=concurrency)) + 
			geom_point() +
			scale_size_continuous(range=c(0,20)) +
    #			scale_fill_manual(values=c('springgreen4', 'gray68')) +
			scale_color_manual(values=c('springgreen4', 'gray68')) +
			theme_bw() + 
			guides(size=FALSE) + 
			labs(color='') + 
			facet_wrap(vars(!!var)) +
			ggtitle(paste('Joint distribution within', degree_1way_vars[j]))

	# I don't know why this works but plotly::style with hoverinfo='prop' does not
	plots_crossnet_1way[[i]][[j]] <- 
	    as_widget(plotly::ggplotly(plots_crossnet_1way[[i]][[j]], tooltip='prop',
						      height=400, 
						      width=800))

	# Concurrency
	tables_conc_1way[[i]][[j]] <- 
	    bind_rows(
		prop_kvar(svy, !!net1_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = paste(quo_name(net1), 'only')),

		prop_kvar(svy, !!net2_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = paste(quo_name(net2), 'only')),

		prop_kvar(svy, !!cross_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = 'cross only'),

		prop_kvar(svy, !!net1_cross_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = paste(quo_name(net1), 'and cross')) ,

		prop_kvar(svy, !!net2_cross_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = paste(quo_name(net2), 'and cross')),

		prop_kvar(svy, !!any_conc_var, binary=TRUE, char_input=FALSE, !!var) %>% 
		    mutate(conc_measure = 'any')

		)
	
	    
	# Plot input must be a data frame, not a DT object. So turn it into DT separately.
	DTables_conc_1way[[i]][[j]] <- DT::datatable(tables_conc_1way[[i]][[j]],
					       height="100%",
					       width="100%", rownames=FALSE)

	# Rotate x labels because they're a little long
	thisplot <- plot_kvar(tables_conc_1way[[i]][[j]], !!var, 
			      conc_measure, char_input=FALSE) + 
		    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
		    ggtitle(paste('Percent of', degree_1way_vars[j], 'with concurrency measure'))

	plots_conc_1way[[i]][[j]] <- 
	    as_widget(plotly::style(thisplot, hoverinfo='y'))

    }
    names(tables_conc_1way[[i]]) <- names(DTables_conc_1way[[i]]) <- 
	names(plots_conc_1way[[i]]) <- 
    names(tables_crossnet_1way[[i]]) <- names(DTables_crossnet_1way[[i]]) <- 
	names(plots_crossnet_1way[[i]]) <- 
	    degree_1way_vars
}
names(tables_conc_1way) <- names(DTables_conc_1way) <- 
    names(plots_conc_1way) <- 
names(tables_crossnet_1way) <- names(DTables_crossnet_1way) <- 
    names(plots_crossnet_1way) <- 
	names(network_pairs)

``` 

## Mean degree overview
```{r nets-overview, results='asis'}
#------------------------------------------------------------
# Networks overview
# print
#------------------------------------------------------------
# kable(sumtable_nets_overview)
plots_nets_overview
knitr::knit_print(sumtable_nets_overview_DT)
```
```{r degree-nets-overview-2}
#plots_nets_overview
```

## One-way mean degree
```{r degree-1way-stats, results='asis'}
#------------------------------------------------------------
# 1-way stats: 
# print
#------------------------------------------------------------

for (var in degree_1way_vars){
   cat('\n')  
   cat("### ", var, " {#degree-1way-", var, "}", "\n", sep="") 

    # Pring the plotly
    x <- plots_1way_mean[[var]]

    #  we know only character and htmlwidget in this case
    #   if more need to handle appropriately
    if(inherits(x,"character")){
	# noquote critical here
	#  also turn off auto.asis very important
	cat(noquote(paste0(x,collapse="\n")))
    } else {
	# print the html piece of the htmlwidgets
	cat(renderTags(x)$html)
    }

    # Print the data table
#   print(kable(tables_1way_mean[[var]]))
    cat(knitr::knit_print(DTables_1way_mean[[var]]))

   cat('\n') 
}
```

```{r degree-plotly-stuff-1way, echo=FALSE, messages=FALSE, warning=FALSE}
#------------------------------------------------------------
# Stuff necessary for plotly plots to print in a loop
# https://github.com/ropensci/plotly/issues/273#issuecomment-195611009
# 
# KEY TO REALIZE: to have more than one loop of plotly graphs print at 
# different points in the same Rmd file, the "deps_1way" variable must
# have a unique name for each loop. So here, we have 1way, and later down,
# this code repeats again after the 2way loop with "deps_2way"
#------------------------------------------------------------
    # attach the Dependencies
    # since the do not get included with renderTags(...)$html
    deps_1way <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_1way_mean),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_1way,recursive=FALSE)
    )
```

## Two-way mean degree
```{r degree-2way-stats, results='asis'}
#------------------------------------------------------------
# 2-way stats: 
# print
#------------------------------------------------------------

for (var in degree_2way_vars_names){
   cat('\n')  
   cat("### ", var, " {#degree-2way-", var, "}", "\n", sep="") 

    x <- plots_2way_mean[[var]]

    #  we know only character and htmlwidget in this case
    #   if more need to handle appropriately
    if(inherits(x,"character")){
	# noquote critical here
	#  also turn off auto.asis very important
	cat(noquote(paste0(x,collapse="\n")))
    } else {
	# print the html piece of the htmlwidgets
	cat(renderTags(x)$html)
    }

    # Print the data table
#    print(kable(tables_2way_mean[[var]]))
    cat(knitr::knit_print(DTables_2way_mean[[var]]))

   cat('\n') 
}
```

```{r degree-plotly-stuff-2way, echo=FALSE, messages=FALSE, warning=FALSE}
#------------------------------------------------------------
# Stuff necessary for plotly plots to print in a loop
# https://github.com/ropensci/plotly/issues/273#issuecomment-195611009
# 
# KEY TO REALIZE: to have more than one loop of plotly graphs print at 
# different points in the same Rmd file, the "deps_2way" variable must
# have a unique name for each loop. So here, we have 2way, and later down,
# this code repeats again after the 2way loop with "deps_2way"
#------------------------------------------------------------
    # attach the Dependencies
    # since the do not get included with renderTags(...)$html
    deps_2way <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_2way_mean),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_2way,recursive=FALSE)
    )
```


```{r degree-crossnet-stats, results='asis'}
#------------------------------------------------------------
# Crossnet overview:
# print
#------------------------------------------------------------

for (netpair in names(network_pairs)){
    cat('\n')  
    cat("## Cross of ", netpair, " {#degree-overview-", netpair, "}", "\n", sep="") 
    cat("### Overview\n")

    x <- plots_crossnet_overview[[netpair]]

    #  we know only character and htmlwidget in this case
    #   if more need to handle appropriately
    if(inherits(x,"character")){
	# noquote critical here
	#  also turn off auto.asis very important
	cat(noquote(paste0(x,collapse="\n")))
    } else {
	# print the html piece of the htmlwidgets
	cat(renderTags(x)$html)
    }

    x2 <- plots_crossnet_overview2[[netpair]]

    if(inherits(x2,"character")){
	cat(noquote(paste0(x2,collapse="\n")))
    } else {
	cat(renderTags(x2)$html)
    }
    # Print the data table
#    print(kable(tables_2way_mean[[var]]))
    cat(knitr::knit_print(DTables_crossnet_overview[[netpair]]))

    cat('\n')  
    #------------------------------------------------------------
    # Now print the 1-way stats for this network pair
    for (var in degree_1way_vars) {

       cat('\n')  
       cat("### ", var, "{#degree-", netpair, "-xnet-", var, "}", "\n", sep="") 

	# Concurrency
	x2 <- plots_conc_1way[[netpair]][[var]]

	#  we know only character and htmlwidget in this case
	#   if more need to handle appropriately
	if(inherits(x2,"character")){
	    # noquote critical here
	    #  also turn off auto.asis very important
	    cat(noquote(paste0(x2,collapse="\n")))
	} else {
	    # print the html piece of the htmlwidgets
	    cat(renderTags(x2)$html)
	}

	# Print the data table
	cat(knitr::knit_print(DTables_conc_1way[[netpair]][[var]]))
	
	# Crossnet
	x3 <- plots_crossnet_1way[[netpair]][[var]]

	if(inherits(x3,"character")){
	    cat(noquote(paste0(x3,collapse="\n")))
	} else {
	    # print the html piece of the htmlwidgets
	    cat(renderTags(x3)$html)
	}

	# Print the data table
	cat(knitr::knit_print(DTables_crossnet_1way[[netpair]][[var]]))
	cat('\n') 
    }
   cat('\n') 

    #------------------------------------------------------------
    # Stuff necessary for plotly plots to print in a loop
    # I don't know if it needs to be within the loop across network pairs, 
    # but it is
    # https://github.com/ropensci/plotly/issues/273#issuecomment-195611009
    # 
    # KEY TO REALIZE: to have more than one loop of plotly graphs print at 
    # different points in the same Rmd file, the "deps_2way" variable must
    # have a unique name for each loop. So here, we have 2way, and later down,
    # this code repeats again after the 2way loop with "deps_2way"
    #------------------------------------------------------------
    deps_conc_1way <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_conc_1way[[i]]),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_conc_1way,recursive=FALSE)
    )

    deps_crossnet_1way <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_crossnet_1way[[i]]),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_crossnet_1way,recursive=FALSE)
    )
}
```

```{r degree-plotly-stuff-conc-1way, echo=FALSE, messages=FALSE, warning=FALSE}
#------------------------------------------------------------
# Stuff necessary for plotly plots to print in a loop
# https://github.com/ropensci/plotly/issues/273#issuecomment-195611009
# 
# KEY TO REALIZE: to have more than one loop of plotly graphs print at 
# different points in the same Rmd file, the "deps_2way" variable must
# have a unique name for each loop. So here, we have 2way, and later down,
# this code repeats again after the 2way loop with "deps_2way"
#------------------------------------------------------------
    # attach the Dependencies
    # since the do not get included with renderTags(...)$html
```
```{r degree-plotly-stuff-crossnet, echo=FALSE, messages=FALSE, warning=FALSE}
#------------------------------------------------------------
# Stuff necessary for plotly plots to print in a loop
# https://github.com/ropensci/plotly/issues/273#issuecomment-195611009
# 
# KEY TO REALIZE: to have more than one loop of plotly graphs print at 
# different points in the same Rmd file, the "deps_2way" variable must
# have a unique name for each loop. So here, we have 2way, and later down,
# this code repeats again after the 2way loop with "deps_2way"
#------------------------------------------------------------
    # attach the Dependencies
    # since the do not get included with renderTags(...)$html
    deps_crossnet <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_crossnet_overview),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_crossnet,recursive=FALSE)
    )

    deps_crossnet2 <- lapply(
      Filter(function(x){inherits(x,"htmlwidget")},plots_crossnet_overview2),
      function(hw){
	renderTags(hw)$dependencies
      }
    )

    attachDependencies(
      tagList(),
      unlist(deps_crossnet2,recursive=FALSE)
    )
```

